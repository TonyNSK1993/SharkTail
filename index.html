<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SharkTail ‚Äî –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–π–∫–∞–º–∏</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<style>
  :root{
    --accent: #7c3aed;
    --accent-2: #06b6d4;
    --bg: linear-gradient(135deg,#f8fbff,#eef6ff);
    --card: rgba(255,255,255,0.9);
    --glass-border: rgba(124,58,237,0.12);
    --text: #0f172a;
    --text-muted: #64748b;
    --table-bg: #ffffff;
    --table-border: #e2e8f0;
    --glass-blur: 8px;
    --sidebar-w: 96px;
  }
  body.dark{
    --bg: linear-gradient(135deg,#071028,#0b1220);
    --card: rgba(18,22,28,0.8);
    --glass-border: rgba(124,58,237,0.14);
    --text: #f1f5f9;
    --text-muted: #94a3b8;
    --table-bg: rgba(30,41,59,0.8);
    --table-border: rgba(71,85,105,0.4);
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing:antialiased;
    transition: background .3s, color .3s;
    overflow: hidden;
  }
  
  .auth-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: var(--bg);
    padding: 20px;
  }

  .auth-card {
    background: var(--card);
    border-radius: 16px;
    padding: 40px;
    width: 100%;
    max-width: 420px;
    box-shadow: 0 20px 60px rgba(2,6,23,0.1);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(var(--glass-blur));
  }

  .auth-header {
    text-align: center;
    margin-bottom: 30px;
  }

  .auth-logo {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg,var(--accent),var(--accent-2));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    color: white;
    font-size: 24px;
    font-weight: bold;
  }

  .auth-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text);
  }

  .auth-subtitle {
    color: var(--text-muted);
    font-size: 14px;
  }

  .auth-form .form-control {
    background: rgba(255,255,255,0.1);
    border: 1px solid var(--glass-border);
    color: var(--text);
    padding: 12px 16px;
    border-radius: 10px;
    margin-bottom: 16px;
  }

  .auth-form .form-control:focus {
    background: rgba(255,255,255,0.15);
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(124,58,237,0.1);
  }

  .auth-form .btn-primary {
    background: linear-gradient(135deg,var(--accent),var(--accent-2));
    border: none;
    padding: 12px;
    border-radius: 10px;
    font-weight: 600;
    width: 100%;
    margin-top: 10px;
  }

  .auth-divider {
    display: flex;
    align-items: center;
    margin: 24px 0;
    color: var(--text-muted);
  }

  .auth-divider::before,
  .auth-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--glass-border);
  }

  .auth-divider span {
    padding: 0 15px;
    font-size: 14px;
  }

  .auth-footer {
    text-align: center;
    margin-top: 20px;
    color: var(--text-muted);
    font-size: 14px;
  }

  .auth-error {
    background: rgba(239,68,68,0.1);
    border: 1px solid rgba(239,68,68,0.3);
    color: #ef4444;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
    display: none;
  }

  .auth-success {
    background: rgba(16,185,129,0.1);
    border: 1px solid rgba(16,185,129,0.3);
    color: #10b981;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
    display: none;
  }

  
  #app {
    display: flex;
    height: 100vh;
    gap: 24px;
    display: none; 
  }
  
  aside.sidebar{
    width:var(--sidebar-w);
    min-width:var(--sidebar-w);
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    border-right:1px solid var(--glass-border);
    backdrop-filter: blur(var(--glass-blur));
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:18px 10px;
    gap:10px;
    transition: width .28s ease;
  }
  aside.sidebar:hover{ width:260px; min-width:260px; }
  .brand{
    display:flex; align-items:center; gap:12px; width:100%;
  }
  .logo{
    display:flex; align-items:center; justify-content:center;
    width:48px; height:48px; border-radius:12px;
    background: linear-gradient(135deg,var(--accent),var(--accent-2));
    color:white; font-weight:700; box-shadow:0 6px 20px rgba(124,58,237,0.18);
  }
  .brand .title{ font-weight:700; opacity:0; transition: opacity .2s; color: var(--text); }
  aside.sidebar:hover .brand .title{ opacity:1; }
  nav.leftnav{ width:100%; display:flex; flex-direction:column; gap:6px; margin-top:6px; }
  nav.leftnav a{
    display:flex; align-items:center; gap:12px; width:100%;
    padding:10px 12px; border-radius:10px; color:var(--text-muted);
    text-decoration:none; transition: all .18s ease;
  }
  nav.leftnav a i{ font-size:1.35rem; width:30px; text-align:center; color:inherit; }
  aside.sidebar:hover nav.leftnav a span{ opacity:1; }
  nav.leftnav a span{ opacity:0; transition: opacity .18s; white-space:nowrap; color: var(--text); }
  nav.leftnav a.active{ background: linear-gradient(90deg, rgba(124,58,237,0.14), rgba(6,182,212,0.06)); color:var(--accent); box-shadow:0 8px 20px rgba(124,58,237,0.08); border-left:4px solid var(--accent); }
  .create-btn{
    margin: auto auto 20px auto;
    width: 56px; 
    height: 56px; 
    border-radius: 999px;
    display: flex; 
    align-items: center; 
    justify-content: center;
    background: linear-gradient(135deg,var(--accent),#4f46e5);
    color: white; 
    box-shadow: 0 10px 30px rgba(79,70,229,0.2); 
    border: none; 
    cursor: pointer;
    transition: all .18s;
    position: relative;
    overflow: hidden;
  }
  aside.sidebar:hover .create-btn{ 
    width: calc(100% - 40px); 
    border-radius: 12px; 
    padding: 0 18px;
  }
  .create-btn span {
    margin-left: 14px; 
    font-weight: 700; 
    opacity: 0;
    transition: opacity .2s;
    white-space: nowrap;
  }
  aside.sidebar:hover .create-btn span {
    opacity: 1;
  }
  .create-btn i {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    transition: all .18s;
  }
  aside.sidebar:hover .create-btn i {
    position: static;
    transform: none;
  }
  main.right{
    flex:1; height:100vh; display:flex; flex-direction:column; overflow:hidden;
  }
  header.topbar{
    height:76px; display:flex; align-items:center; gap:16px; padding:12px 22px;
    border-bottom:1px solid var(--glass-border); background:var(--card); backdrop-filter: blur(var(--glass-blur));
  }
  header .section-title{ font-weight:700; font-size:1.05rem; margin-right:12px; color: var(--text); }
  .search-wrap{ flex:1; display:flex; justify-content:center; }
  .search{
    width:60%; min-width:240px; max-width:720px; display:flex; gap:8px; align-items:center;
    background:var(--card); padding:8px 12px; border-radius:12px; border:1px solid var(--glass-border);
  }
  .search input{ border:none; outline:none; background:transparent; width:100%; color: var(--text); }
  .search input::placeholder{ color: var(--text-muted); }
  .top-actions{ display:flex; align-items:center; gap:12px; }
  .top-actions .user-info {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    transition: background .2s;
  }
  .top-actions .user-info:hover {
    background: rgba(124,58,237,0.1);
  }
  .user-menu {
    position: absolute;
    top: 60px;
    right: 20px;
    background: var(--card);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    padding: 8px 0;
    min-width: 200px;
    box-shadow: 0 10px 40px rgba(2,6,23,0.1);
    display: none;
    z-index: 1000;
  }
  .user-menu.show {
    display: block;
  }
  .user-menu-item {
    padding: 10px 16px;
    color: var(--text);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background .2s;
    cursor: pointer;
  }
  .user-menu-item:hover {
    background: rgba(124,58,237,0.1);
  }
  .user-menu-divider {
    height: 1px;
    background: var(--glass-border);
    margin: 4px 0;
  }
  .content{
    padding:20px; height: calc(100vh - 76px); overflow:auto;
    -webkit-overflow-scrolling:touch;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 18px;
  }
  .card{
    background:var(--card); border-radius:14px; padding:16px; box-shadow: 0 6px 20px rgba(2,6,23,0.05);
    transition: transform .18s ease, box-shadow .18s ease;
    backdrop-filter: blur(var(--glass-blur));
    border:1px solid var(--glass-border);
    color: var(--text);
  }
  .card:hover{ transform: translateY(-6px); box-shadow:0 12px 40px rgba(2,6,23,0.08); }
  .card.stat {
    padding: 12px;
    min-height: 80px;
    position: relative;
  }
  .stat {
    display: flex;
    flex-direction: column;
    gap: 6px;
    height: 100%;
  }
  .stat .meta {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
  }
  .stat .value {
    font-size: 1.3rem;
    font-weight: 800;
    line-height: 1.1;
  }
  .stat .label {
    color: var(--text-muted);
    font-size: 0.8rem;
    font-weight: 500;
    margin-bottom: 2px;
  }
  .stat .muted {
    color: var(--text-muted);
    font-size: 0.7rem;
    display: flex;
    gap: 4px;
    align-items: center;
  }
  .stat .muted span {
    font-weight: 600;
    color: var(--text);
  }
  .stat-icon {
    position: absolute;
    top: 12px;
    right: 12px;
    opacity: 0.8;
  }
  .stat-icon i {
    font-size: 1.6rem;
  }
  .chart-wrap{ height:280px; display:flex; align-items:center; }
  table.table { 
    margin-bottom:0; 
    background:var(--table-bg);
    border:1px solid var(--table-border);
    border-radius:8px;
    overflow:hidden;
    color: var(--text) !important;
  }
  .table th{ 
    background:var(--table-bg) !important; 
    color:var(--text-muted) !important; 
    font-weight:600; 
    font-size:0.85rem;
    padding:12px 16px;
    border-bottom:1px solid var(--table-border) !important;
  }
  .table td{ 
    padding:10px 16px;
    border-bottom:1px solid var(--table-border) !important;
    color: var(--text) !important;
    font-size:0.9rem;
    background:var(--table-bg) !important;
  }
  tbody tr{ 
    transition: background .12s ease;
    background:var(--table-bg) !important;
  }
  tbody tr:hover{ 
    background: var(--card) !important; 
  }
  tbody tr:last-child td{ border-bottom:none; }
  .badge-status { 
    padding:4px 8px; 
    border-radius:999px; 
    font-weight:600; 
    font-size:0.75rem;
    display: inline-block;
    min-width: 80px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .badge-status:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .modal-content{ 
    border-radius:14px; 
    background:var(--card); 
    border:1px solid var(--glass-border); 
    box-shadow:0 20px 60px rgba(2,6,23,0.1);
    color: var(--text);
  }
  .modal-header{ border-bottom:none; }
  .modal-body{ color: var(--text); }
  .form-control, .form-select{
    background:var(--card);
    border:1px solid var(--glass-border);
    color: var(--text);
  }
  .form-control::placeholder{ color: var(--text-muted); }
  .toast-wrap{ position:fixed; right:22px; bottom:22px; z-index:2000; }
  .muted{ color:var(--text-muted); font-size:0.85rem; }
  .fadeup{ animation: fadeUp .45s cubic-bezier(.2,.9,.3,1); }
  @keyframes fadeUp{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }
  .wash-bay-card {
    transition: all 0.2s ease;
  }
  .wash-bay-card.available:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.15);
  }
  .wash-bay-card.busy {
    background-color: var(--card);
  }
  .schedule-grid {
    display: grid;
    grid-template-columns: 120px repeat(14, 1fr);
    gap: 1px;
    font-size: 0.8rem;
  }
  .schedule-header, .schedule-row {
    display: contents;
  }
  .time-slot {
    padding: 4px;
    border: 1px solid var(--table-border);
    text-align: center;
    min-height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .bay-name {
    padding: 4px;
    border: 1px solid var(--table-border);
    font-weight: 600;
    display: flex;
    align-items: center;
  }
  .free { background-color: rgba(16, 185, 129, 0.1); }
  .status-pending { background-color: rgba(148, 163, 184, 0.3); }
  .status-confirmed { background-color: rgba(59, 130, 246, 0.3); }
  .status-arrived { background-color: rgba(245, 158, 11, 0.3); }
  .status-inwash { background-color: rgba(124, 58, 237, 0.3); }
  .status-completed { background-color: rgba(16, 185, 129, 0.3); }
  .multiselect {
    min-height: 100px;
    max-height: 200px;
    overflow-y: auto;
  }
  .multiselect option {
    padding: 8px 12px;
    border-bottom: 1px solid var(--table-border);
  }
  .multiselect option:last-child {
    border-bottom: none;
  }
  @media (max-width:900px){
    aside.sidebar{ width:66px; min-width:66px; }
    aside.sidebar:hover{ width:210px; min-width:210px; }
    .search{ width:100%; max-width:unset; }
    .grid{ 
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
  }
  @media (max-width:480px){
    .grid{
      grid-template-columns: 1fr;
      gap: 8px;
    }
  }
  .compact-table .table td{ padding:8px 12px; font-size:0.85rem; }
  .compact-table .table th{ padding:10px 12px; font-size:0.8rem; }
  .btn-sm{ padding:4px 8px; font-size:0.8rem; }
</style>
</head>
<body>

<div id="authContainer" class="auth-container">
  <div class="auth-card">
    <div class="auth-header">
      <div class="auth-logo">ü¶à</div>
      <h2 class="auth-title">SharkTail</h2>
      <p class="auth-subtitle">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–π–∫–∞–º–∏</p>
    </div>
    
    
    <div id="loginForm" class="auth-form">
      <div id="loginError" class="auth-error"></div>
      <div id="loginSuccess" class="auth-success"></div>
      
      <input type="text" 
             id="loginUsername" 
             class="form-control" 
             placeholder="–õ–æ–≥–∏–Ω" 
             autocomplete="username">
      
      <input type="password" 
             id="loginPassword" 
             class="form-control" 
             placeholder="–ü–∞—Ä–æ–ª—å" 
             autocomplete="current-password">
      
      <button id="loginBtn" class="btn btn-primary">
        <i class="bi bi-box-arrow-in-right"></i> –í–æ–π—Ç–∏
      </button>
      
      <div class="auth-divider">
        <span>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?</span>
      </div>
      
      <button id="showRegisterBtn" class="btn btn-outline-primary">
        <i class="bi bi-person-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
      </button>
    </div>
    
    
    <div id="registerForm" class="auth-form" style="display: none;">
      <div id="registerError" class="auth-error"></div>
      <div id="registerSuccess" class="auth-success"></div>
      
      <input type="text" 
             id="registerName" 
             class="form-control" 
             placeholder="–í–∞—à–µ –∏–º—è">
      
      <input type="text" 
             id="registerUsername" 
             class="form-control" 
             placeholder="–õ–æ–≥–∏–Ω"
             autocomplete="username">
      
      <input type="password" 
             id="registerPassword" 
             class="form-control" 
             placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)"
             autocomplete="new-password">
      
      <input type="password" 
             id="registerConfirmPassword" 
             class="form-control" 
             placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
             autocomplete="new-password">
      
      <button id="registerBtn" class="btn btn-primary">
        <i class="bi bi-person-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
      </button>
      
      <div class="auth-divider">
        <span>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?</span>
      </div>
      
      <button id="showLoginBtn" class="btn btn-outline-primary">
        <i class="bi bi-box-arrow-in-right"></i> –í–æ–π—Ç–∏
      </button>
    </div>
    
    <div class="auth-footer">
      <p>SharkTail ¬© 2026</p>
    </div>
  </div>
</div>


<div id="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">ü¶à</div>
      <div class="title">SharkTail</div>
    </div>
    <nav class="leftnav" id="nav">
      <a href="#" class="nav-link active" data-section="dashboard"><i class="bi bi-speedometer2"></i><span>–î–∞—à–±–æ—Ä–¥</span></a>
      <a href="#" class="nav-link" data-section="clients"><i class="bi bi-people"></i><span>–ö–ª–∏–µ–Ω—Ç—ã</span></a>
      <a href="#" class="nav-link" data-section="cars"><i class="bi bi-car-front"></i><span>–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</span></a>
      <a href="#" class="nav-link" data-section="services"><i class="bi bi-tools"></i><span>–£—Å–ª—É–≥–∏</span></a>
      <a href="#" class="nav-link" data-section="employees"><i class="bi bi-person-badge"></i><span>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span></a>
      <a href="#" class="nav-link" data-section="appointments"><i class="bi bi-calendar-check"></i><span>–ó–∞–ø–∏—Å–∏</span></a>
      <a href="#" class="nav-link" data-section="shifts"><i class="bi bi-clock"></i><span>–°–º–µ–Ω—ã</span></a>
      <a href="#" class="nav-link" data-section="carwashes"><i class="bi bi-building"></i><span>–ú–æ–π–∫–∏</span></a>
      <a href="#" class="nav-link" data-section="washbays"><i class="bi bi-geo-alt"></i><span>–ú–æ–µ—á–Ω—ã–µ –º–µ—Å—Ç–∞</span></a>
      <a href="#" class="nav-link" data-section="load-dashboard"><i class="bi bi-calendar-week"></i><span>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–µ–∫</span></a>
    </nav>
    <button class="create-btn" id="openCreate">
      <i class="bi bi-plus-lg"></i>
      <span>–°–æ–∑–¥–∞—Ç—å</span>
    </button>
  </aside>
  
  <main class="right">
    <header class="topbar">
      <div class="section-title">–î–∞—à–±–æ—Ä–¥</div>
      <div class="search-wrap">
        <div class="search" id="searchBox">
          <i class="bi bi-search" style="color: var(--text-muted);"></i>
          <input id="globalSearch" placeholder="–ü–æ–∏—Å–∫: –∏–º—è, –Ω–æ–º–µ—Ä, —É—Å–ª—É–≥–∞..." autocomplete="off">
          <div id="searchSuggestions" style="position:absolute; margin-top:44px; width:60%; max-width:720px; z-index:50;"></div>
        </div>
      </div>
      <div class="top-actions">
        <button class="btn btn-sm" id="themeToggle" title="–¢–µ–º–∞">üåô</button>
        <button class="btn btn-sm position-relative" id="notifBtn" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"><i class="bi bi-bell" style="color: var(--text);"></i><span id="notifPing" style="position:absolute; right:2px; top:-2px; width:8px; height:8px; background:#ef4444; border-radius:999px; display:none;"></span></button>
        
        
        <div class="user-info" id="userInfoBtn">
          <img src="https://i.pravatar.cc/40" class="rounded-circle" alt="avatar">
          <div>
            <div id="userName">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
            <div class="muted" id="userRole">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
          </div>
          <i class="bi bi-chevron-down"></i>
        </div>
        
        
        <div class="user-menu" id="userMenu">
          <div class="user-menu-item">
            <i class="bi bi-person"></i>
            <span id="menuUserName">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
          </div>
          <div class="user-menu-item">
            <i class="bi bi-gear"></i>
            <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
          </div>
          <div class="user-menu-divider"></div>
          <div class="user-menu-item" id="logoutBtn">
            <i class="bi bi-box-arrow-right"></i>
            <span>–í—ã–π—Ç–∏</span>
          </div>
        </div>
      </div>
    </header>
    
    <section class="content">
      
      <div id="dashboard" class="view fadeup">
        <div class="grid" id="statsGrid">
          <div class="card stat">
            <div class="label">–í—ã—Ä—É—á–∫–∞ —Å–µ–≥–æ–¥–Ω—è</div>
            <div class="value" id="revenue-today">0 ‚ÇΩ</div>
            <div class="muted">–ó–∞–≤–µ—Ä—à–µ–Ω–æ: <span id="completed-today">0</span></div>
            <div class="stat-icon">
              <i class="bi bi-currency-dollar" style="color:#10b981"></i>
            </div>
          </div>
          <div class="card stat">
            <div class="label">–í—ã—Ä—É—á–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
            <div class="value" id="revenue-week">0 ‚ÇΩ</div>
            <div class="muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö: <span id="active-week">0</span></div>
            <div class="stat-icon">
              <i class="bi bi-graph-up" style="color:#7c3aed"></i>
            </div>
          </div>
          <div class="card stat">
            <div class="label">–í—ã—Ä—É—á–∫–∞ –∑–∞ –º–µ—Å—è—Ü</div>
            <div class="value" id="revenue-month">0 ‚ÇΩ</div>
            <div class="muted">–í—Å–µ–≥–æ: <span id="total-appointments">0</span></div>
            <div class="stat-icon">
              <i class="bi bi-calendar-month" style="color:#f59e0b"></i>
            </div>
          </div>
          <div class="card stat">
            <div class="label">–ö–ª–∏–µ–Ω—Ç—ã</div>
            <div class="value" id="total-clients">0</div>
            <div class="muted">–ê–≤—Ç–æ: <span id="total-cars">0</span></div>
            <div class="stat-icon">
              <i class="bi bi-people" style="color:#06b6d4"></i>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top:18px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
            <div style="display:flex; gap:12px; align-items:center;">
              <h5 style="margin:0">–ì—Ä–∞—Ñ–∏–∫–∏ ‚Äî –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h5>
              <div class="muted">–¥–∏–Ω–∞–º–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π</div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn btn-sm btn-outline-secondary" id="exportCsvBtn"><i class="bi bi-download"></i> –≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>
          </div>
          <div style="display:grid; grid-template-columns: 1fr 380px; gap:16px; align-items:center;">
            <div class="card" style="padding:10px;">
              <div class="chart-wrap">
                <canvas id="chartDaily" style="width:100%;"></canvas>
              </div>
            </div>
            <div class="card" style="padding:10px;">
              <div style="display:flex; align-items:center; justify-content:space-between;">
                <div><strong>–¢–æ–ø —É—Å–ª—É–≥</strong><div class="muted">–ø–æ —á–∏—Å–ª—É –∑–∞–ø–∏—Å–µ–π</div></div>
                <div><i class="bi bi-pie-chart-fill" style="font-size:1.4rem; color:var(--accent)"></i></div>
              </div>
              <div style="height:220px; display:flex; align-items:center; justify-content:center; margin-top:8px;">
                <canvas id="chartTop" style="max-width:260px;"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top:18px;">
          <h5 style="margin:0 0 12px 0">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h5>
          <table class="table compact-table">
            <thead><tr><th>–í—Ä–µ–º—è</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–ê–≤—Ç–æ</th><th>–£—Å–ª—É–≥–∞</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–°—É–º–º–∞</th></tr></thead>
            <tbody id="recent-appointments"></tbody>
          </table>
        </div>
      </div>
      
      
      <div id="clients" class="view fadeup" style="display:none;">
        <div class="card" style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h5 style="margin:0">–ö–ª–∏–µ–Ω—Ç—ã</h5><div class="muted">—Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div></div>
            <div><button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#clientModal">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</button></div>
          </div>
        </div>
        <div class="card">
          <table class="table compact-table">
            <thead><tr><th>–§–ò–û / –ö–æ–º–ø–∞–Ω–∏—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>Email</th><th>–ê–≤—Ç–æ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="clientsTbody"></tbody>
          </table>
        </div>
      </div>
      
      <div id="cars" class="view fadeup" style="display:none;">
        <div class="card" style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h5 style="margin:0">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</h5><div class="muted">—É—á–µ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∫–ª–∏–µ–Ω—Ç–æ–≤</div></div>
            <div><button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#carModal">+ –ù–æ–≤–æ–µ –∞–≤—Ç–æ</button></div>
          </div>
        </div>
        <div class="card">
          <table class="table compact-table">
            <thead><tr><th>–ì–æ—Å–Ω–æ–º–µ—Ä</th><th>–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å</th><th>–ì–æ–¥</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–¢–∏–ø –∫—É–∑–æ–≤–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="carsTbody"></tbody>
          </table>
        </div>
      </div>
      <div id="services" class="view fadeup" style="display:none;">
        <div class="card" style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h5 style="margin:0">–£—Å–ª—É–≥–∏</h5><div class="muted">–ø—Ä–∞–π—Å-–ª–∏—Å—Ç —É—Å–ª—É–≥</div></div>
            <div><button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#serviceModal">+ –ù–æ–≤–∞—è —É—Å–ª—É–≥–∞</button></div>
          </div>
        </div>
        <div class="card">
          <table class="table compact-table">
            <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¢–∏–ø</th><th>–¶–µ–Ω–∞ (‚ÇΩ)</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="servicesTbody"></tbody>
          </table>
        </div>
      </div>
      <div id="employees" class="view fadeup" style="display:none;">
        <div class="card" style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h5 style="margin:0">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h5><div class="muted">—É—á–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∞</div></div>
            <div><button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#employeeModal">+ –ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</button></div>
          </div>
        </div>
        <div class="card">
          <table class="table compact-table">
            <thead><tr><th>–ò–º—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–†–æ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="employeesTbody"></tbody>
          </table>
        </div>
      </div>
      <div id="appointments" class="view fadeup" style="display:none;">
        <div class="card" style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h5 style="margin:0">–ó–∞–ø–∏—Å–∏</h5><div class="muted">—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏</div></div>
            <div><button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#appointmentModal">+ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button></div>
          </div>
        </div>
        <div class="card mb-3">
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select id="filterStatus" class="form-select" onchange="applyFilters()">
                  <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                  <option value="pending">–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</option>
                  <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</option>
                  <option value="arrived">–ö–ª–∏–µ–Ω—Ç –ø—Ä–∏–µ—Ö–∞–ª</option>
                  <option value="in_wash">–ù–∞ –º–æ–π–∫–µ</option>
                  <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                  <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">–ú–æ–π–∫–∞</label>
                <select id="filterCarWash" class="form-select" onchange="applyFilters()">
                  <option value="">–í—Å–µ –º–æ–π–∫–∏</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">–î–∞—Ç–∞ —Å</label>
                <input id="filterDateFrom" type="date" class="form-control" onchange="applyFilters()">
              </div>
              <div class="col-md-3">
                <label class="form-label">–î–∞—Ç–∞ –ø–æ</label>
                <input id="filterDateTo" type="date" class="form-control" onchange="applyFilters()">
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <table class="table compact-table">
            <thead><tr><th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–ê–≤—Ç–æ</th><th>–£—Å–ª—É–≥–∞</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ú–æ–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ</th><th>–°—É–º–º–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="appointmentsTbody"></tbody>
          </table>
        </div>
      </div>
      <div id="shifts" class="view fadeup" style="display:none;">
        <div class="card" style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h5 style="margin:0">–†–∞–±–æ—á–∏–µ —Å–º–µ–Ω—ã</h5><div class="muted">—É—á–µ—Ç —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</div></div>
            <div><button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#shiftModal">+ –ù–æ–≤–∞—è —Å–º–µ–Ω–∞</button></div>
          </div>
        </div>
        <div class="card">
          <table class="table compact-table">
            <thead><tr><th>–î–∞—Ç–∞</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–ù–∞—á–∞–ª–æ</th><th>–ö–æ–Ω–µ—Ü</th><th>–ê–≤—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="shiftsTbody"></tbody>
          </table>
        </div>
      </div>
      <div id="carwashes" class="view fadeup" style="display:none;">
        <div class="card" style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h5 style="margin:0">–ú–æ–π–∫–∏</h5><div class="muted">—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–π–∫–∞–º–∏</div></div>
            <div><button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#carWashModal">+ –ù–æ–≤–∞—è –º–æ–π–∫–∞</button></div>
          </div>
        </div>
        <div class="card">
          <table class="table compact-table">
            <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ê–¥—Ä–µ—Å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–ª-–≤–æ –º–µ—Å—Ç</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="carwashesTbody"></tbody>
          </table>
        </div>
      </div>
      <div id="washbays" class="view fadeup" style="display:none;">
        <div class="card" style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h5 style="margin:0">–ú–æ–µ—á–Ω—ã–µ –º–µ—Å—Ç–∞</h5><div class="muted">—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–º–∏ –º–æ–π–∫–∏</div></div>
            <div><button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#washBayModal">+ –ù–æ–≤–æ–µ –º–µ—Å—Ç–æ</button></div>
          </div>
        </div>
        <div class="card">
          <table class="table compact-table">
            <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ú–æ–π–∫–∞</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="washbaysTbody"></tbody>
          </table>
        </div>
      </div>
      <div id="load-dashboard" class="view fadeup" style="display:none;">
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <div>
              <h5 style="margin:0">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–µ–∫</h5>
              <div class="muted">—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –∑–∞–Ω—è—Ç–æ—Å—Ç—å</div>
            </div>
            <div>
              <input type="date" id="loadDashboardDate" class="form-control" onchange="renderLoadDashboard()">
            </div>
          </div>
          <div id="loadDashboardContent">
          </div>
        </div>
      </div>
      
    </section>
  </main>
</div>
<div class="modal fade" id="clientModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 id="clientModalTitle">–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="clientId">
        <input id="clientName" class="form-control mb-2" placeholder="–§–ò–û / –ö–æ–º–ø–∞–Ω–∏—è" required>
        <input id="clientPhone" class="form-control mb-2" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <input id="clientEmail" class="form-control mb-2" placeholder="Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
        <textarea id="clientPreferences" class="form-control" placeholder="–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è" rows="2"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="saveClientBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="carModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 id="carModalTitle">–ù–æ–≤–æ–µ –∞–≤—Ç–æ</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="carId">
        <select id="carClientIds" class="form-select mb-2 multiselect" multiple>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤</option>
        </select>
        <input id="carPlate" class="form-control mb-2" placeholder="–ì–æ—Å–Ω–æ–º–µ—Ä" required>
        <input id="carBrand" class="form-control mb-2" placeholder="–ú–∞—Ä–∫–∞" required>
        <input id="carModel" class="form-control mb-2" placeholder="–ú–æ–¥–µ–ª—å" required>
        <input id="carYear" class="form-control mb-2" type="number" placeholder="–ì–æ–¥">
        <select id="carBodyType" class="form-select">
          <option value="—Å–µ–¥–∞–Ω">–°–µ–¥–∞–Ω</option>
          <option value="–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫">–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫</option>
          <option value="—Ö—ç—Ç—á–±–µ–∫">–•—ç—Ç—á–±–µ–∫</option>
          <option value="—É–Ω–∏–≤–µ—Ä—Å–∞–ª">–£–Ω–∏–≤–µ—Ä—Å–∞–ª</option>
          <option value="–º–∏–Ω–∏–≤—ç–Ω">–ú–∏–Ω–∏–≤—ç–Ω</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="saveCarBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="serviceModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 id="serviceModalTitle">–ù–æ–≤–∞—è —É—Å–ª—É–≥–∞</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="serviceId">
        <input id="serviceName" class="form-control mb-2" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
        <select id="serviceType" class="form-select mb-2">
          <option value="–º–æ–π–∫–∞">–ú–æ–π–∫–∞</option>
          <option value="–¥–æ–ø">–î–æ–ø. —É—Å–ª—É–≥–∞</option>
        </select>
        <input id="servicePrice" class="form-control" type="number" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="saveServiceBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="employeeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 id="employeeModalTitle">–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="employeeId">
        <input id="employeeName" class="form-control mb-2" placeholder="–ò–º—è" required>
        <input id="employeePhone" class="form-control mb-2" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <input id="employeeRole" class="form-control" placeholder="–†–æ–ª—å">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="saveEmployeeBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="appointmentModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 id="appointmentModalTitle">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body row gx-3">
        <input type="hidden" id="appointmentId">
        <div class="col-md-6"><label class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label><input id="apptDateTime" class="form-control" type="datetime-local" required></div>
        <div class="col-md-6"><label class="form-label">–ö–ª–∏–µ–Ω—Ç</label>
          <select id="apptClient" class="form-select" onchange="loadCarsForClient()">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>
            <option value="new">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</option>
          </select>
        </div>
        <div class="col-md-6"><label class="form-label">–ê–≤—Ç–æ</label>
          <select id="apptCar" class="form-select">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ</option>
            <option value="new">+ –ù–æ–≤–æ–µ –∞–≤—Ç–æ</option>
          </select>
        </div>
        <div class="col-md-6"><label class="form-label">–£—Å–ª—É–≥–∞</label><select id="apptService" class="form-select" onchange="updateAppointmentPrice()"></select></div>
        <div class="col-md-6"><label class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label><select id="apptEmployee" class="form-select"></select></div>
        <div class="col-md-6"><label class="form-label">–°—Ç–∞—Ç—É—Å</label>
          <select id="apptStatus" class="form-select">
            <option value="pending">–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</option>
            <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</option>
            <option value="arrived">–ö–ª–∏–µ–Ω—Ç –ø—Ä–∏–µ—Ö–∞–ª</option>
            <option value="in_wash">–ù–∞ –º–æ–π–∫–µ</option>
            <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
            <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
          </select>
        </div>
        <div class="col-md-6"><label class="form-label">–¶–µ–Ω–∞ (‚ÇΩ)</label><input id="apptPrice" class="form-control" type="number"></div>
        <div class="col-md-6">
          <label class="form-label">–ú–æ–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ</label>
          <div class="input-group">
            <select id="apptWashBay" class="form-select">
              <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
            </select>
            <button class="btn btn-outline-secondary" type="button" onclick="openWashBayModal()">
              <i class="bi bi-geo-alt"></i>
            </button>
          </div>
        </div>
        <div id="newCarFields" class="col-md-12" style="display:none;">
          <div class="card mt-2 p-3">
            <h6>–ù–æ–≤–æ–µ –∞–≤—Ç–æ</h6>
            <div class="row g-2">
              <div class="col-md-4"><input id="newCarPlate" class="form-control" placeholder="–ì–æ—Å–Ω–æ–º–µ—Ä"></div>
              <div class="col-md-4"><input id="newCarBrand" class="form-control" placeholder="–ú–∞—Ä–∫–∞"></div>
              <div class="col-md-4"><input id="newCarModel" class="form-control" placeholder="–ú–æ–¥–µ–ª—å"></div>
            </div>
          </div>
        </div>
        <div class="col-md-12"><label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea id="apptComment" class="form-control" rows="2"></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="saveApptBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="shiftModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 id="shiftModalTitle">–ù–æ–≤–∞—è —Å–º–µ–Ω–∞</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="shiftId">
        <input id="shiftDate" class="form-control mb-2" type="date" required>
        <select id="shiftEmployeeId" class="form-select mb-2"></select>
        <input id="shiftStart" class="form-control mb-2" type="time" required>
        <input id="shiftEnd" class="form-control mb-2" type="time" required>
        <input id="shiftCarsCount" class="form-control" type="number" min="0" placeholder="–ê–≤—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="saveShiftBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="carWashModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 id="carWashModalTitle">–ù–æ–≤–∞—è –º–æ–π–∫–∞</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="carWashId">
        <input id="carWashName" class="form-control mb-2" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–π–∫–∏" required>
        <input id="carWashAddress" class="form-control mb-2" placeholder="–ê–¥—Ä–µ—Å">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="carWashIsActive" checked>
          <label class="form-check-label" for="carWashIsActive">–ê–∫—Ç–∏–≤–Ω–∞</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="saveCarWashBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="washBayModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 id="washBayModalTitle">–ù–æ–≤–æ–µ –º–æ–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="washBayId">
        <select id="washBayCarWashId" class="form-select mb-2">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–π–∫—É</option>
        </select>
        <input id="washBayName" class="form-control mb-2" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞" required>
        <input id="washBayDescription" class="form-control mb-2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="washBayIsActive" checked>
          <label class="form-check-label" for="washBayIsActive">–ê–∫—Ç–∏–≤–Ω–æ</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="saveWashBayBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="washBaySelectionModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5>–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">–ú–æ–π–∫–∞</label>
            <select id="washBayCarWash" class="form-select" onchange="loadAvailableWashBays()">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–π–∫—É</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
            <input id="washBayDateTime" class="form-control" type="datetime-local">
          </div>
        </div>
        <div id="washBayGrid" class="row g-2">
        </div>
        <div id="washBayNoSlots" class="text-center py-4" style="display:none;">
          <i class="bi bi-calendar-x" style="font-size:2rem; color:var(--text-muted);"></i>
          <p class="mt-2">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="statusModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="statusAppointmentId">
        <select id="statusSelect" class="form-select">
          <option value="pending">–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</option>
          <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</option>
          <option value="arrived">–ö–ª–∏–µ–Ω—Ç –ø—Ä–∏–µ—Ö–∞–ª</option>
          <option value="in_wash">–ù–∞ –º–æ–π–∫–µ</option>
          <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
          <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" onclick="saveQuickStatus()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toastWrap"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_URL = 'http://localhost:3001';


let currentUser = null;


async function checkAuth() {
  try {
    const response = await fetch(`${API_URL}/api/auth/check`, {
      credentials: 'include' 
    });
    
    const data = await response.json();
    
    if (data.isAuthenticated && data.user) {
      currentUser = data.user;
      showApp();
      return true;
    } else {
      showAuth();
      return false;
    }
  } catch (error) {
    console.error('Auth check error:', error);
    showAuth();
    return false;
  }
}

async function login(username, password) {
  try {
    showAuthMessage('loginError', '');
    showAuthMessage('loginSuccess', '');
    
    const response = await fetch(`${API_URL}/api/auth/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ username, password }),
      credentials: 'include'
    });
    
    const data = await response.json();
    
    if (data.success) {
      currentUser = data.user;
      showAuthMessage('loginSuccess', '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
      setTimeout(() => {
        showApp();
      }, 1000);
      return true;
    } else {
      showAuthMessage('loginError', data.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
      return false;
    }
  } catch (error) {
    console.error('Login error:', error);
    showAuthMessage('loginError', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    return false;
  }
}

async function register(name, username, password) {
  try {
    showAuthMessage('registerError', '');
    showAuthMessage('registerSuccess', '');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
    if (password.length < 6) {
      showAuthMessage('registerError', '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');
      return false;
    }
    
    if (password !== document.getElementById('registerConfirmPassword').value) {
      showAuthMessage('registerError', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
      return false;
    }
    
    const response = await fetch(`${API_URL}/api/auth/register`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ name, username, password }),
      credentials: 'include'
    });
    
    const data = await response.json();
    
    if (data.success) {
      currentUser = data.user;
      showAuthMessage('registerSuccess', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!');
      setTimeout(() => {
        showApp();
      }, 1000);
      return true;
    } else {
      showAuthMessage('registerError', data.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
      return false;
    }
  } catch (error) {
    console.error('Register error:', error);
    showAuthMessage('registerError', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    return false;
  }
}

async function logout() {
  try {
    await fetch(`${API_URL}/api/auth/logout`, {
      method: 'POST',
      credentials: 'include'
    });
    
    currentUser = null;
    showAuth();
    showToast('–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
  } catch (error) {
    console.error('Logout error:', error);
  }
}

function showAuthMessage(elementId, message) {
  const element = document.getElementById(elementId);
  if (element) {
    element.textContent = message;
    element.style.display = message ? 'block' : 'none';
  }
}

function showAuth() {
  document.getElementById('authContainer').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('registerForm').style.display = 'none';
  
 
  document.getElementById('loginUsername').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginError').style.display = 'none';
  document.getElementById('loginSuccess').style.display = 'none';
}

function showApp() {
  document.getElementById('authContainer').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  

  if (currentUser) {
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userRole').textContent = currentUser.role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('menuUserName').textContent = currentUser.name;
    
    
    const avatar = document.querySelector('.user-info img');
    if (avatar) {
      
      const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=7c3aed&color=fff&size=40`;
      avatar.src = avatarUrl;
    }
  }
  
  
  initCRM();
}

function switchAuthForm(toRegister) {
  if (toRegister) {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    
    
    showAuthMessage('loginError', '');
    showAuthMessage('loginSuccess', '');
    showAuthMessage('registerError', '');
    showAuthMessage('registerSuccess', '');
  } else {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
    
    
    document.getElementById('registerName').value = '';
    document.getElementById('registerUsername').value = '';
    document.getElementById('registerPassword').value = '';
    document.getElementById('registerConfirmPassword').value = '';
    showAuthMessage('registerError', '');
    showAuthMessage('registerSuccess', '');
    showAuthMessage('loginError', '');
    showAuthMessage('loginSuccess', '');
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
document.getElementById('loginBtn').addEventListener('click', async () => {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  
  if (!username || !password) {
    showAuthMessage('loginError', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    return;
  }
  
  document.getElementById('loginBtn').disabled = true;
  document.getElementById('loginBtn').innerHTML = '<i class="bi bi-arrow-repeat spin"></i> –í—Ö–æ–¥...';
  
  await login(username, password);
  
  document.getElementById('loginBtn').disabled = false;
  document.getElementById('loginBtn').innerHTML = '<i class="bi bi-box-arrow-in-right"></i> –í–æ–π—Ç–∏';
});

document.getElementById('registerBtn').addEventListener('click', async () => {
  const name = document.getElementById('registerName').value.trim();
  const username = document.getElementById('registerUsername').value.trim();
  const password = document.getElementById('registerPassword').value;
  
  if (!name || !username || !password) {
    showAuthMessage('registerError', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    return;
  }
  
  document.getElementById('registerBtn').disabled = true;
  document.getElementById('registerBtn').innerHTML = '<i class="bi bi-arrow-repeat spin"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
  
  await register(name, username, password);
  
  document.getElementById('registerBtn').disabled = false;
  document.getElementById('registerBtn').innerHTML = '<i class="bi bi-person-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
});

document.getElementById('showRegisterBtn').addEventListener('click', () => {
  switchAuthForm(true);
});

document.getElementById('showLoginBtn').addEventListener('click', () => {
  switchAuthForm(false);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ —Ñ–æ—Ä–º–∞—Ö
document.getElementById('loginUsername').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('loginPassword').focus();
  }
});

document.getElementById('loginPassword').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('loginBtn').click();
  }
});

document.getElementById('registerName').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('registerUsername').focus();
  }
});

document.getElementById('registerUsername').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('registerPassword').focus();
  }
});

document.getElementById('registerPassword').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('registerConfirmPassword').focus();
  }
});

document.getElementById('registerConfirmPassword').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('registerBtn').click();
  }
});

// –ú–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
document.getElementById('userInfoBtn').addEventListener('click', (e) => {
  e.stopPropagation();
  const menu = document.getElementById('userMenu');
  menu.classList.toggle('show');
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  logout();
  document.getElementById('userMenu').classList.remove('show');
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener('click', (e) => {
  if (!e.target.closest('.user-info') && !e.target.closest('.user-menu')) {
    document.getElementById('userMenu').classList.remove('show');
  }
});


const style = document.createElement('style');
style.textContent = `
  .spin {
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', async () => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  const isAuthenticated = await checkAuth();
  
  if (isAuthenticated) {
    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', currentUser);
  } else {
    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞');
  }
});

const storage = {
  clients: JSON.parse(localStorage.getItem('crm_clients')||'[]'),
  cars: JSON.parse(localStorage.getItem('crm_cars')||'[]'),
  services: JSON.parse(localStorage.getItem('crm_services')||'[]'),
  employees: JSON.parse(localStorage.getItem('crm_employees')||'[]'),
  appointments: JSON.parse(localStorage.getItem('crm_appts')||'[]'),
  shifts: JSON.parse(localStorage.getItem('crm_shifts')||'[]'),
  carWashes: JSON.parse(localStorage.getItem('crm_carwashes')||'[]'),
  washBays: JSON.parse(localStorage.getItem('crm_washbays')||'[]'),
  save(){ 
    localStorage.setItem('crm_clients', JSON.stringify(this.clients));
    localStorage.setItem('crm_cars', JSON.stringify(this.cars));
    localStorage.setItem('crm_services', JSON.stringify(this.services));
    localStorage.setItem('crm_employees', JSON.stringify(this.employees));
    localStorage.setItem('crm_appts', JSON.stringify(this.appointments));
    localStorage.setItem('crm_shifts', JSON.stringify(this.shifts));
    localStorage.setItem('crm_carwashes', JSON.stringify(this.carWashes));
    localStorage.setItem('crm_washbays', JSON.stringify(this.washBays));
  }
};

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
let chartDaily=null, chartTop=null;

function initCRM() {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  seedDemo();
  fillSelects();
  fillFilterSelects();
  updateDashboard();
  renderCharts();
  renderRecentAppointments();
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
  const today = new Date().toISOString().split('T')[0];
  $('#loadDashboardDate').value = today;
  $('#shiftDate').value = today;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–º—É
  if(localStorage.getItem('crm_theme_dark')==='1'){ 
    document.body.classList.add('dark'); 
    $('#themeToggle').textContent='‚òÄÔ∏è'; 
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  const pendingAppointments = storage.appointments.filter(a => a.status === 'pending');
  if (pendingAppointments.length > 0) {
    $('#notifPing').style.display = 'block';
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  $all('nav.leftnav a').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      $all('nav.leftnav a').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      const section = a.getAttribute('data-section');
      switchView(section);
    });
  });
  
  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã
  $('#themeToggle').addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    $('#themeToggle').textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('crm_theme_dark', document.body.classList.contains('dark')? '1':'0');
  });
}

function seedDemo(){
  if(storage.clients.length===0){
    const now = new Date();
    const isoDate = now.toISOString().slice(0,16);
    
    storage.clients = [
      {id:1, name:"–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤", phone:"+79991112233", email:"ivan@example.com", preferences:"–¢–æ–ª—å–∫–æ —Ä—É—á–Ω–∞—è –º–æ–π–∫–∞"},
      {id:2, name:"–ú–∞—Ä–∏—è –°–æ–∫–æ–ª–æ–≤–∞", phone:"+79003332211", email:"maria@example.com", preferences:""},
      {id:3, name:"–ê–ª–µ–∫—Å–µ–π –ò–≤–∞–Ω–æ–≤", phone:"+79994445566", email:"alex@example.com", preferences:""}
    ];
    
    storage.cars = [
      {id:1, clientIds:[1], plate:"–ê123–í–°", brand:"Toyota", model:"Camry", year:2020, bodyType:"—Å–µ–¥–∞–Ω"},
      {id:2, clientIds:[2], plate:"–û987–ö–•", brand:"Kia", model:"Rio", year:2019, bodyType:"—Ö—ç—Ç—á–±–µ–∫"},
      {id:3, clientIds:[1,2], plate:"–ï555–¢–¢", brand:"BMW", model:"X5", year:2021, bodyType:"–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫"}
    ];
    
    storage.services = [
      {id:1, name:"–†—É—á–Ω–∞—è –º–æ–π–∫–∞", type:"–º–æ–π–∫–∞", price:800},
      {id:2, name:"–ê–Ω—Ç–∏–¥–µ–≥–æ—Ç—å", type:"–¥–æ–ø", price:300},
      {id:3, name:"–•–∏–º—á–∏—Å—Ç–∫–∞ —Å–∞–ª–æ–Ω–∞", type:"–¥–æ–ø", price:1500},
      {id:4, name:"–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –º–æ–π–∫–∞", type:"–º–æ–π–∫–∞", price:1200}
    ];
    
    storage.employees = [
      {id:1, name:"–ê–Ω–¥—Ä–µ–π", phone:"+79994445566", role:"–ú–æ–π—â–∏–∫"},
      {id:2, name:"–°–µ—Ä–≥–µ–π", phone:"+79995556677", role:"–°—Ç–∞—Ä—à–∏–π –º–æ–π—â–∏–∫"}
    ];
    
    storage.carWashes = [
      {id: 1, name: "–ì–ª–∞–≤–Ω–∞—è –º–æ–π–∫–∞", address: "—É–ª. –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è, 1", isActive: true},
      {id: 2, name: "–§–∏–ª–∏–∞–ª –°–µ–≤–µ—Ä–Ω—ã–π", address: "—É–ª. –°–µ–≤–µ—Ä–Ω–∞—è, 15", isActive: true},
      {id: 3, name: "–ú–æ–π–∫–∞ –ü—Ä–µ–º–∏—É–º", address: "–ø—Ä. –õ–µ–Ω–∏–Ω–∞, 45", isActive: false}
    ];
    
    storage.washBays = [
      {id: 1, carWashId: 1, name: "–ü–æ—Å—Ç ‚Ññ1", description: "–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Å—Ç", isActive: true},
      {id: 2, carWashId: 1, name: "–ü–æ—Å—Ç ‚Ññ2", description: "–ë–æ–∫—Å –¥–ª—è –≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫–æ–≤", isActive: true},
      {id: 3, carWashId: 2, name: "–ë–æ–∫—Å –ê", description: "–ë—ã—Å—Ç—Ä–∞—è –º–æ–π–∫–∞", isActive: true},
      {id: 4, carWashId: 2, name: "–ë–æ–∫—Å –ë", description: "–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –º–æ–π–∫–∞", isActive: true},
      {id: 5, carWashId: 3, name: "VIP –±–æ–∫—Å", description: "–ü—Ä–µ–º–∏—É–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ", isActive: false}
    ];
    
    storage.appointments = [
      {id:1, dateTime: new Date(Date.now()-3*24*3600*1000).toISOString().slice(0,16), clientId:1, carId:1, serviceId:1, employeeId:1, status:"completed", price:800, comment:"", washBayId:1},
      {id:2, dateTime: new Date(Date.now()-2*24*3600*1000).toISOString().slice(0,16), clientId:2, carId:2, serviceId:2, employeeId:2, status:"completed", price:300, comment:"", washBayId:2},
      {id:3, dateTime: isoDate, clientId:1, carId:1, serviceId:3, employeeId:1, status:"confirmed", price:1500, comment:"–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å", washBayId:1},
      {id:4, dateTime: new Date(Date.now()+2*3600*1000).toISOString().slice(0,16), clientId:3, carId:3, serviceId:4, employeeId:2, status:"pending", price:1200, comment:"", washBayId:3}
    ];
    
    storage.shifts = [
      {id:1, date: new Date().toISOString().split('T')[0], employeeId:1, start:"09:00", end:"18:00", carsCount:8},
      {id:2, date: new Date().toISOString().split('T')[0], employeeId:2, start:"10:00", end:"19:00", carsCount:12}
    ];
    
    storage.save();
  }
}

function $(sel){ return document.querySelector(sel); }
function $all(sel){ return Array.from(document.querySelectorAll(sel)); }

function showToast(message, type='success'){
  const id = 't'+Date.now();
  const wrap = $('#toastWrap');
  const el = document.createElement('div');
  el.className = 'toast align-items-center text-white bg-'+(type==='success'?'success':'danger')+' border-0';
  el.role = 'alert'; el.ariaLive='assertive'; el.ariaAtomic='true';
  el.style.minWidth='220px';
  el.innerHTML = `<div class="d-flex">
    <div class="toast-body">${message}</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
  </div>`;
  wrap.appendChild(el);
  const t = new bootstrap.Toast(el, {delay:3500});
  t.show();
  el.addEventListener('hidden.bs.toast', ()=> el.remove());
}

function formatDateTime(dtStr) {
  const dt = new Date(dtStr);
  return dt.toLocaleDateString('ru-RU') + ' ' + dt.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

function switchView(id){
  $all('.view').forEach(v=> v.style.display='none');
  const el = $('#'+id);
  if(el) el.style.display = 'block';
  const title = el ? el.querySelector('h5') || el.querySelector('.muted') || el.querySelector('.card h5') : null;
  $('.section-title').textContent = id==='dashboard' ? '–î–∞—à–±–æ—Ä–¥' : (id[0].toUpperCase()+id.slice(1));
  
  if(id==='dashboard'){ 
    updateDashboard(); 
    renderCharts(); 
  } else if(id==='clients'){ 
    renderClientsTable(); 
  } else if(id==='cars'){ 
    renderCarsTable(); 
  } else if(id==='services'){ 
    renderServicesTable(); 
  } else if(id==='employees'){ 
    renderEmployeesTable(); 
  } else if(id==='appointments'){ 
    renderApptsTable(); 
  } else if(id==='shifts'){ 
    renderShiftsTable(); 
  } else if(id==='carwashes'){ 
    renderCarWashesTable(); 
  } else if(id==='washbays'){ 
    renderWashBaysTable(); 
  } else if(id==='load-dashboard'){ 
    renderLoadDashboard(); 
  }
}

function renderClientsTable(){
  const tb = $('#clientsTbody'); tb.innerHTML='';
  storage.clients.forEach(c=>{
    const carsCount = storage.cars.filter(x=>x.clientIds.includes(c.id)).length;
    const row = document.createElement('tr');
    row.innerHTML = `<td>${c.name}</td>
      <td>${c.phone||''}</td>
      <td>${c.email||''}</td>
      <td>${carsCount}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editClient(${c.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteClient(${c.id})"><i class="bi bi-trash"></i></button>
      </td>`;
    tb.appendChild(row);
  });
}

function renderCarsTable(){
  const tb = $('#carsTbody'); tb.innerHTML='';
  storage.cars.forEach(car=>{
    const clients = storage.clients.filter(c => car.clientIds.includes(c.id));
    const clientNames = clients.map(c => c.name).join(', ');
    const row = document.createElement('tr');
    row.innerHTML = `<td>${car.plate}</td>
      <td>${car.brand} ${car.model}</td>
      <td>${car.year || ''}</td>
      <td>${clientNames || '‚Äî'}</td>
      <td>${car.bodyType}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editCar(${car.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteCar(${car.id})"><i class="bi bi-trash"></i></button>
      </td>`;
    tb.appendChild(row);
  });
}

function renderServicesTable(){
  const tb = $('#servicesTbody'); tb.innerHTML='';
  storage.services.forEach(s=>{
    const row = document.createElement('tr');
    row.innerHTML = `<td>${s.name}</td>
      <td>${s.type === '–º–æ–π–∫–∞' ? '–ú–æ–π–∫–∞' : '–î–æ–ø. —É—Å–ª—É–≥–∞'}</td>
      <td>${s.price}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editService(${s.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteService(${s.id})"><i class="bi bi-trash"></i></button>
      </td>`;
    tb.appendChild(row);
  });
}

function renderEmployeesTable(){
  const tb = $('#employeesTbody'); tb.innerHTML='';
  storage.employees.forEach(e=>{
    const row = document.createElement('tr');
    row.innerHTML = `<td>${e.name}</td>
      <td>${e.phone || ''}</td>
      <td>${e.role || ''}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editEmployee(${e.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee(${e.id})"><i class="bi bi-trash"></i></button>
      </td>`;
    tb.appendChild(row);
  });
}

function renderApptsTable(){
  const tb = $('#appointmentsTbody'); tb.innerHTML='';
  const filteredAppts = getFilteredAppointments();
  
  filteredAppts.sort((a,b)=>new Date(b.dateTime)-new Date(a.dateTime)).forEach(a=>{
    const client = storage.clients.find(c=>c.id===a.clientId) || {};
    const car = storage.cars.find(c=>c.id===a.carId) || {};
    const service = storage.services.find(s=>s.id===a.serviceId) || {};
    const emp = storage.employees.find(e=>e.id===a.employeeId) || {};
    const washBay = storage.washBays.find(b=>b.id===a.washBayId) || {};
    
    const statusMap = { 
      'pending': '#94a3b8', 
      'confirmed': '#3b82f6', 
      'arrived': '#f59e0b', 
      'in_wash': '#7c3aed', 
      'completed': '#10b981', 
      'cancelled': '#ef4444' 
    };
    
    const statusTextMap = {
      'pending': '–û–∂–∏–¥–∞–µ—Ç',
      'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞',
      'arrived': '–ü—Ä–∏–µ—Ö–∞–ª',
      'in_wash': '–ù–∞ –º–æ–π–∫–µ',
      'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
      'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–∞'
    };
    
    const row = document.createElement('tr');
    row.innerHTML = `<td>${formatDateTime(a.dateTime)}</td>
      <td>${client.name||'‚Äî'}</td>
      <td>${car.plate||'‚Äî'}</td>
      <td>${service.name||'‚Äî'}</td>
      <td>${emp.name||'‚Äî'}</td>
      <td><span class="badge-status" style="background:${statusMap[a.status]}; color:white;" onclick="quickChangeStatus(${a.id})">${statusTextMap[a.status]}</span></td>
      <td>${washBay.name || '‚Äî'}</td>
      <td>${a.price||0} ‚ÇΩ</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editAppt(${a.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteAppt(${a.id})"><i class="bi bi-trash"></i></button>
      </td>`;
    tb.appendChild(row);
  });
}

function renderShiftsTable(){
  const tb = $('#shiftsTbody'); tb.innerHTML='';
  storage.shifts.forEach(s=>{
    const emp = storage.employees.find(e=>e.id===s.employeeId) || {};
    const row = document.createElement('tr');
    row.innerHTML = `<td>${s.date}</td>
      <td>${emp.name||'‚Äî'}</td>
      <td>${s.start}</td>
      <td>${s.end}</td>
      <td>${s.carsCount||0}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editShift(${s.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteShift(${s.id})"><i class="bi bi-trash"></i></button>
      </td>`;
    tb.appendChild(row);
  });
}

function renderCarWashesTable(){
  const tb = $('#carwashesTbody'); tb.innerHTML='';
  storage.carWashes.forEach(cw=>{
    const baysCount = storage.washBays.filter(b => b.carWashId === cw.id).length;
    const row = document.createElement('tr');
    row.innerHTML = `<td>${cw.name}</td>
      <td>${cw.address||''}</td>
      <td><span class="badge ${cw.isActive ? 'bg-success' : 'bg-secondary'}">${cw.isActive ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}</span></td>
      <td>${baysCount}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editCarWash(${cw.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteCarWash(${cw.id})"><i class="bi bi-trash"></i></button>
      </td>`;
    tb.appendChild(row);
  });
}

function renderWashBaysTable(){
  const tb = $('#washbaysTbody'); tb.innerHTML='';
  storage.washBays.forEach(bay=>{
    const carWash = storage.carWashes.find(cw => cw.id === bay.carWashId);
    const row = document.createElement('tr');
    row.innerHTML = `<td>${bay.name}</td>
      <td>${carWash?.name || '‚Äî'}</td>
      <td>${bay.description||''}</td>
      <td><span class="badge ${bay.isActive ? 'bg-success' : 'bg-secondary'}">${bay.isActive ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–æ'}</span></td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editWashBay(${bay.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteWashBay(${bay.id})"><i class="bi bi-trash"></i></button>
      </td>`;
    tb.appendChild(row);
  });
}

function renderRecentAppointments(){
  const tb = $('#recent-appointments'); tb.innerHTML='';
  const recent = [...storage.appointments]
    .sort((a,b)=>new Date(b.dateTime)-new Date(a.dateTime))
    .slice(0, 10);
  
  recent.forEach(a=>{
    const client = storage.clients.find(c=>c.id===a.clientId) || {};
    const car = storage.cars.find(c=>c.id===a.carId) || {};
    const service = storage.services.find(s=>s.id===a.serviceId) || {};
    const emp = storage.employees.find(e=>e.id===a.employeeId) || {};
    
    const statusMap = { 
      'pending': '#94a3b8', 
      'confirmed': '#3b82f6', 
      'arrived': '#f59e0b', 
      'in_wash': '#7c3aed', 
      'completed': '#10b981', 
      'cancelled': '#ef4444' 
    };
    
    const statusTextMap = {
      'pending': '–û–∂–∏–¥–∞–µ—Ç',
      'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞',
      'arrived': '–ü—Ä–∏–µ—Ö–∞–ª',
      'in_wash': '–ù–∞ –º–æ–π–∫–µ',
      'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
      'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–∞'
    };
    
    const row = document.createElement('tr');
    row.innerHTML = `<td>${formatDateTime(a.dateTime)}</td>
      <td>${client.name||'‚Äî'}</td>
      <td>${car.plate||'‚Äî'}</td>
      <td>${service.name||'‚Äî'}</td>
      <td>${emp.name||'‚Äî'}</td>
      <td><span class="badge-status" style="background:${statusMap[a.status]}; color:white;">${statusTextMap[a.status]}</span></td>
      <td>${a.price||0} ‚ÇΩ</td>`;
    tb.appendChild(row);
  });
}

function saveClient(){
  const id = $('#clientId').value || Date.now();
  const name = $('#clientName').value.trim();
  const phone = $('#clientPhone').value.trim();
  const email = $('#clientEmail').value.trim();
  const preferences = $('#clientPreferences').value.trim();
  
  if(!name){ showToast('–£–∫–∞–∂–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞','error'); return; }
  
  const client = { id: parseInt(id), name, phone, email, preferences };
  const idx = storage.clients.findIndex(c => c.id == id);
  
  if(idx === -1) {
    storage.clients.push(client);
  } else {
    storage.clients[idx] = client;
  }
  
  storage.save();
  renderClientsTable();
  fillSelects();
  bootstrap.Modal.getInstance($('#clientModal')).hide();
  resetClientModal();
  showToast(idx === -1 ? '–ö–ª–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω' : '–ö–ª–∏–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω');
}

function deleteClient(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≤—Å–µ –µ–≥–æ –∞–≤—Ç–æ?')) return;
  storage.cars = storage.cars.filter(c=>!c.clientIds.includes(id));
  storage.clients = storage.clients.filter(c=>c.id!==id);
  storage.save();
  renderClientsTable(); 
  renderApptsTable(); 
  renderCarsTable();
  fillSelects(); 
  updateDashboard(); 
  renderCharts();
  showToast('–ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª—ë–Ω');
}

function editClient(id){
  const c = storage.clients.find(x=>x.id===id);
  if(!c) return;
  $('#clientId').value = c.id;
  $('#clientName').value = c.name;
  $('#clientPhone').value = c.phone || '';
  $('#clientEmail').value = c.email || '';
  $('#clientPreferences').value = c.preferences || '';
  $('#clientModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞';
  new bootstrap.Modal($('#clientModal')).show();
}

function resetClientModal(){
  $('#clientId').value = '';
  $('#clientName').value = '';
  $('#clientPhone').value = '';
  $('#clientEmail').value = '';
  $('#clientPreferences').value = '';
  $('#clientModalTitle').textContent = '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç';
}

function saveCar(){
  const id = $('#carId').value || Date.now();
  const clientIds = Array.from($('#carClientIds').selectedOptions).map(opt => parseInt(opt.value));
  const plate = $('#carPlate').value.trim();
  const brand = $('#carBrand').value.trim();
  const model = $('#carModel').value.trim();
  const year = parseInt($('#carYear').value) || null;
  const bodyType = $('#carBodyType').value;
  
  if(!plate || clientIds.length === 0){ 
    showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≥–æ—Å–Ω–æ–º–µ—Ä –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤','error'); 
    return; 
  }
  
  const car = { 
    id: parseInt(id), 
    clientIds,
    plate, 
    brand, 
    model, 
    year, 
    bodyType 
  };
  
  const idx = storage.cars.findIndex(c => c.id == id);
  
  if(idx === -1) {
    storage.cars.push(car);
  } else {
    storage.cars[idx] = car;
  }
  
  storage.save();
  renderCarsTable();
  fillSelects();
  bootstrap.Modal.getInstance($('#carModal')).hide();
  resetCarModal();
  showToast(idx === -1 ? '–ê–≤—Ç–æ–º–æ–±–∏–ª—å –¥–æ–±–∞–≤–ª–µ–Ω' : '–ê–≤—Ç–æ–º–æ–±–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
}

function deleteCar(id){
  if(confirm('–£–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ?')) {
    storage.cars = storage.cars.filter(c=>c.id!==id);
    storage.save();
    renderCarsTable();
    renderApptsTable();
    fillSelects();
    showToast('–ê–≤—Ç–æ–º–æ–±–∏–ª—å —É–¥–∞–ª—ë–Ω');
  }
}

function editCar(id){
  const c = storage.cars.find(x=>x.id===id);
  if(!c) return;
  $('#carId').value = c.id;
  const clientSelect = $('#carClientIds');
  Array.from(clientSelect.options).forEach(option => {
    option.selected = c.clientIds.includes(parseInt(option.value));
  });
  
  $('#carPlate').value = c.plate;
  $('#carBrand').value = c.brand;
  $('#carModel').value = c.model;
  $('#carYear').value = c.year || '';
  $('#carBodyType').value = c.bodyType;
  $('#carModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ';
  fillSelects();
  new bootstrap.Modal($('#carModal')).show();
}

function resetCarModal(){
  $('#carId').value = '';
  $('#carClientIds').selectedIndex = -1;
  $('#carPlate').value = '';
  $('#carBrand').value = '';
  $('#carModel').value = '';
  $('#carYear').value = '';
  $('#carBodyType').value = '—Å–µ–¥–∞–Ω';
  $('#carModalTitle').textContent = '–ù–æ–≤–æ–µ –∞–≤—Ç–æ';
}

function saveService(){
  const id = $('#serviceId').value || Date.now();
  const name = $('#serviceName').value.trim();
  const type = $('#serviceType').value;
  const price = parseFloat($('#servicePrice').value);
  
  if(!name || isNaN(price)){ showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É','error'); return; }
  
  const service = { id: parseInt(id), name, type, price };
  const idx = storage.services.findIndex(s => s.id == id);
  
  if(idx === -1) {
    storage.services.push(service);
  } else {
    storage.services[idx] = service;
  }
  
  storage.save();
  renderServicesTable();
  fillSelects();
  bootstrap.Modal.getInstance($('#serviceModal')).hide();
  resetServiceModal();
  showToast(idx === -1 ? '–£—Å–ª—É–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞' : '–£—Å–ª—É–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
}

function deleteService(id){
  if(confirm('–£–¥–∞–ª–∏—Ç—å —É—Å–ª—É–≥—É?')) {
    storage.services = storage.services.filter(s=>s.id!==id);
    storage.save();
    renderServicesTable();
    fillSelects();
    showToast('–£—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞');
  }
}

function editService(id){
  const s = storage.services.find(x=>x.id===id);
  if(!s) return;
  $('#serviceId').value = s.id;
  $('#serviceName').value = s.name;
  $('#serviceType').value = s.type;
  $('#servicePrice').value = s.price;
  $('#serviceModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Å–ª—É–≥—É';
  new bootstrap.Modal($('#serviceModal')).show();
}

function resetServiceModal(){
  $('#serviceId').value = '';
  $('#serviceName').value = '';
  $('#serviceType').value = '–º–æ–π–∫–∞';
  $('#servicePrice').value = '';
  $('#serviceModalTitle').textContent = '–ù–æ–≤–∞—è —É—Å–ª—É–≥–∞';
}

function saveEmployee(){
  const id = $('#employeeId').value || Date.now();
  const name = $('#employeeName').value.trim();
  const phone = $('#employeePhone').value.trim();
  const role = $('#employeeRole').value.trim();
  
  if(!name){ showToast('–£–∫–∞–∂–∏—Ç–µ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞','error'); return; }
  
  const employee = { id: parseInt(id), name, phone, role };
  const idx = storage.employees.findIndex(e => e.id == id);
  
  if(idx === -1) {
    storage.employees.push(employee);
  } else {
    storage.employees[idx] = employee;
  }
  
  storage.save();
  renderEmployeesTable();
  fillSelects();
  bootstrap.Modal.getInstance($('#employeeModal')).hide();
  resetEmployeeModal();
  showToast(idx === -1 ? '–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω' : '–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω');
}

function deleteEmployee(id){
  if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) {
    storage.employees = storage.employees.filter(e=>e.id!==id);
    storage.save();
    renderEmployeesTable();
    fillSelects();
    showToast('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–¥–∞–ª—ë–Ω');
  }
}

function editEmployee(id){
  const e = storage.employees.find(x=>x.id===id);
  if(!e) return;
  $('#employeeId').value = e.id;
  $('#employeeName').value = e.name;
  $('#employeePhone').value = e.phone || '';
  $('#employeeRole').value = e.role || '';
  $('#employeeModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
  new bootstrap.Modal($('#employeeModal')).show();
}

function resetEmployeeModal(){
  $('#employeeId').value = '';
  $('#employeeName').value = '';
  $('#employeePhone').value = '';
  $('#employeeRole').value = '';
  $('#employeeModalTitle').textContent = '–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫';
}

function saveAppt(){
  const id = $('#appointmentId').value || Date.now();
  const dateTime = $('#apptDateTime').value;
  const clientId = parseInt($('#apptClient').value);
  const carId = $('#apptCar').value === 'new' ? null : parseInt($('#apptCar').value);
  const serviceId = parseInt($('#apptService').value);
  const employeeId = parseInt($('#apptEmployee').value) || null;
  const status = $('#apptStatus').value;
  const price = parseFloat($('#apptPrice').value) || 0;
  const comment = $('#apptComment').value || '';
  const washBayId = parseInt($('#apptWashBay').value) || null;

  let newCarId = null;
  if ($('#apptCar').value === 'new') {
    const plate = $('#newCarPlate').value.trim();
    const brand = $('#newCarBrand').value.trim();
    const model = $('#newCarModel').value.trim();
    
    if (plate && brand && model) {
      newCarId = Date.now();
      const newCar = {
        id: newCarId,
        clientIds: [clientId],
        plate,
        brand,
        model,
        year: null,
        bodyType: '—Å–µ–¥–∞–Ω'
      };
      storage.cars.push(newCar);
    }
  }
  
  if(!dateTime || !clientId || !serviceId){ 
    showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞—Ç—É, –∫–ª–∏–µ–Ω—Ç–∞ –∏ —É—Å–ª—É–≥—É','error'); 
    return; 
  }
  
  const finalCarId = newCarId || carId;
  
  const appointment = { 
    id: parseInt(id), 
    dateTime: new Date(dateTime).toISOString(), 
    clientId, 
    carId: finalCarId,
    serviceId, 
    employeeId, 
    status, 
    price, 
    comment,
    washBayId
  };
  
  const idx = storage.appointments.findIndex(a => a.id == id);
  
  if(idx === -1) {
    storage.appointments.push(appointment);
  } else {
    storage.appointments[idx] = appointment;
  }
  
  storage.save(); 
  renderApptsTable(); 
  renderRecentAppointments();
  updateDashboard(); 
  renderCharts();
  bootstrap.Modal.getInstance($('#appointmentModal')).hide();
  resetAppointmentModal();
  showToast(idx === -1 ? '–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞' : '–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
}

function deleteAppt(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
  storage.appointments = storage.appointments.filter(a=>a.id!==id);
  storage.save(); 
  renderApptsTable(); 
  renderRecentAppointments();
  updateDashboard(); 
  renderCharts(); 
  showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
}

function editAppt(id){
  const a = storage.appointments.find(x=>x.id===id);
  if(!a) return;
  $('#appointmentId').value = a.id;
  $('#apptDateTime').value = new Date(a.dateTime).toISOString().slice(0,16);
  $('#apptClient').value = a.clientId; 
  loadCarsForClient(); 
  setTimeout(()=> $('#apptCar').value = a.carId, 50);
  $('#apptService').value = a.serviceId;
  $('#apptEmployee').value = a.employeeId;
  $('#apptStatus').value = a.status;
  $('#apptPrice').value = a.price;
  $('#apptComment').value = a.comment;
  $('#apptWashBay').value = a.washBayId || '';
  $('#appointmentModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å';
  new bootstrap.Modal($('#appointmentModal')).show();
}

function resetAppointmentModal(){
  $('#appointmentId').value = '';
  $('#apptDateTime').value = '';
  $('#apptClient').value = '';
  $('#apptCar').innerHTML = '<option value="">‚Äî –∞–≤—Ç–æ ‚Äî</option><option value="new">+ –ù–æ–≤–æ–µ –∞–≤—Ç–æ</option>';
  $('#apptService').value = '';
  $('#apptEmployee').value = '';
  $('#apptStatus').value = 'pending';
  $('#apptPrice').value = '';
  $('#apptComment').value = '';
  $('#apptWashBay').value = '';
  $('#newCarFields').style.display = 'none';
  $('#appointmentModalTitle').textContent = '–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å';
}

function saveShift(){
  const id = $('#shiftId').value || Date.now();
  const date = $('#shiftDate').value;
  const employeeId = parseInt($('#shiftEmployeeId').value);
  const start = $('#shiftStart').value;
  const end = $('#shiftEnd').value;
  const carsCount = parseInt($('#shiftCarsCount').value) || 0;
  
  if(!date || !employeeId || !start || !end){ 
    showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è','error'); 
    return; 
  }
  
  const shift = { 
    id: parseInt(id), 
    date, 
    employeeId, 
    start, 
    end, 
    carsCount 
  };
  
  const idx = storage.shifts.findIndex(s => s.id == id);
  
  if(idx === -1) {
    storage.shifts.push(shift);
  } else {
    storage.shifts[idx] = shift;
  }
  
  storage.save(); 
  renderShiftsTable();
  bootstrap.Modal.getInstance($('#shiftModal')).hide();
  resetShiftModal();
  showToast(idx === -1 ? '–°–º–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞' : '–°–º–µ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
}

function deleteShift(id){
  if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–º–µ–Ω—É?')) {
    storage.shifts = storage.shifts.filter(s=>s.id!==id);
    storage.save(); 
    renderShiftsTable();
  }
}

function editShift(id){
  const s = storage.shifts.find(x=>x.id===id);
  if(!s) return;
  $('#shiftId').value = s.id;
  $('#shiftDate').value = s.date;
  $('#shiftEmployeeId').value = s.employeeId;
  $('#shiftStart').value = s.start;
  $('#shiftEnd').value = s.end;
  $('#shiftCarsCount').value = s.carsCount;
  $('#shiftModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–º–µ–Ω—É';
  fillSelects();
  new bootstrap.Modal($('#shiftModal')).show();
}

function resetShiftModal(){
  $('#shiftId').value = '';
  $('#shiftDate').value = '';
  $('#shiftEmployeeId').value = '';
  $('#shiftStart').value = '';
  $('#shiftEnd').value = '';
  $('#shiftCarsCount').value = '';
  $('#shiftModalTitle').textContent = '–ù–æ–≤–∞—è —Å–º–µ–Ω–∞';
}

function saveCarWash(){
  const id = $('#carWashId').value || Date.now();
  const name = $('#carWashName').value.trim();
  const address = $('#carWashAddress').value.trim();
  const isActive = $('#carWashIsActive').checked;
  
  if(!name){ showToast('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–π–∫–∏','error'); return; }
  
  const carWash = { 
    id: parseInt(id), 
    name, 
    address, 
    isActive 
  };
  
  const idx = storage.carWashes.findIndex(cw => cw.id == id);
  
  if(idx === -1) {
    storage.carWashes.push(carWash);
  } else {
    storage.carWashes[idx] = carWash;
  }
  
  storage.save();
  renderCarWashesTable();
  fillSelects();
  bootstrap.Modal.getInstance($('#carWashModal')).hide();
  resetCarWashModal();
  showToast(idx === -1 ? '–ú–æ–π–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞' : '–ú–æ–π–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
}

function deleteCarWash(id){
  const hasBays = storage.washBays.some(bay => bay.carWashId === id);
  if(hasBays){
    showToast('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –º–æ–π–∫—É —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º–∏ –º–µ—Å—Ç–∞–º–∏','error');
    return;
  }
  
  if(confirm('–£–¥–∞–ª–∏—Ç—å –º–æ–π–∫—É?')) {
    storage.carWashes = storage.carWashes.filter(cw=>cw.id!==id);
    storage.save();
    renderCarWashesTable();
    fillSelects();
    showToast('–ú–æ–π–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
  }
}

function editCarWash(id){
  const cw = storage.carWashes.find(x=>x.id===id);
  if(!cw) return;
  $('#carWashId').value = cw.id;
  $('#carWashName').value = cw.name;
  $('#carWashAddress').value = cw.address || '';
  $('#carWashIsActive').checked = cw.isActive;
  $('#carWashModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–π–∫—É';
  new bootstrap.Modal($('#carWashModal')).show();
}

function resetCarWashModal(){
  $('#carWashId').value = '';
  $('#carWashName').value = '';
  $('#carWashAddress').value = '';
  $('#carWashIsActive').checked = true;
  $('#carWashModalTitle').textContent = '–ù–æ–≤–∞—è –º–æ–π–∫–∞';
}

function saveWashBay(){
  const id = $('#washBayId').value || Date.now();
  const carWashId = parseInt($('#washBayCarWashId').value);
  const name = $('#washBayName').value.trim();
  const description = $('#washBayDescription').value.trim();
  const isActive = $('#washBayIsActive').checked;
  
  if(!name || !carWashId){ 
    showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–π–∫—É','error'); 
    return; 
  }
  
  const washBay = { 
    id: parseInt(id), 
    carWashId, 
    name, 
    description, 
    isActive 
  };
  
  const idx = storage.washBays.findIndex(wb => wb.id == id);
  
  if(idx === -1) {
    storage.washBays.push(washBay);
  } else {
    storage.washBays[idx] = washBay;
  }
  
  storage.save();
  renderWashBaysTable();
  fillSelects();
  bootstrap.Modal.getInstance($('#washBayModal')).hide();
  resetWashBayModal();
  showToast(idx === -1 ? '–ú–æ–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ' : '–ú–æ–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
}

function deleteWashBay(id){
  const hasAppointments = storage.appointments.some(appt => appt.washBayId === id);
  if(hasAppointments){
    showToast('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –º–µ—Å—Ç–æ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏','error');
    return;
  }
  
  if(confirm('–£–¥–∞–ª–∏—Ç—å –º–æ–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ?')) {
    storage.washBays = storage.washBays.filter(wb=>wb.id!==id);
    storage.save();
    renderWashBaysTable();
    fillSelects();
    showToast('–ú–æ–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–æ');
  }
}

function editWashBay(id){
  const wb = storage.washBays.find(x=>x.id===id);
  if(!wb) return;
  $('#washBayId').value = wb.id;
  $('#washBayCarWashId').value = wb.carWashId;
  $('#washBayName').value = wb.name;
  $('#washBayDescription').value = wb.description || '';
  $('#washBayIsActive').checked = wb.isActive;
  $('#washBayModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ';
  fillSelects();
  new bootstrap.Modal($('#washBayModal')).show();
}

function resetWashBayModal(){
  $('#washBayId').value = '';
  $('#washBayCarWashId').value = '';
  $('#washBayName').value = '';
  $('#washBayDescription').value = '';
  $('#washBayIsActive').checked = true;
  $('#washBayModalTitle').textContent = '–ù–æ–≤–æ–µ –º–æ–µ—á–Ω–æ–µ –º–µ—Å—Ç–æ';
}

function quickChangeStatus(appointmentId) {
  const appointment = storage.appointments.find(a => a.id === appointmentId);
  if (!appointment) return;
  
  $('#statusAppointmentId').value = appointmentId;
  $('#statusSelect').value = appointment.status;
  new bootstrap.Modal($('#statusModal')).show();
}

function saveQuickStatus() {
  const appointmentId = parseInt($('#statusAppointmentId').value);
  const newStatus = $('#statusSelect').value;
  
  const appointment = storage.appointments.find(a => a.id === appointmentId);
  if (appointment) {
    appointment.status = newStatus;
    storage.save();
    renderApptsTable();
    renderRecentAppointments();
    updateDashboard();
    bootstrap.Modal.getInstance($('#statusModal')).hide();
    showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω');
  }
}

function openWashBayModal() {
  const dateTime = $('#apptDateTime').value;
  if (!dateTime) {
    showToast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è', 'error');
    return;
  }
  
  $('#washBayDateTime').value = dateTime;
  fillCarWashSelect();
  loadAvailableWashBays();
  new bootstrap.Modal($('#washBaySelectionModal')).show();
}

function fillCarWashSelect() {
  const select = $('#washBayCarWash');
  select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–π–∫—É</option>';
  storage.carWashes.filter(w => w.isActive).forEach(wash => {
    const option = document.createElement('option');
    option.value = wash.id;
    option.textContent = wash.name;
    select.appendChild(option);
  });
}

function loadAvailableWashBays() {
  const carWashId = parseInt($('#washBayCarWash').value);
  const dateTime = $('#washBayDateTime').value;
  
  if (!carWashId || !dateTime) return;
  
  const grid = $('#washBayGrid');
  const noSlots = $('#washBayNoSlots');
  grid.innerHTML = '';
  
  const washBays = storage.washBays.filter(bay => 
    bay.carWashId === carWashId && bay.isActive
  );
  
  let availableCount = 0;
  
  washBays.forEach(bay => {
    const isAvailable = isWashBayAvailable(bay.id, dateTime);
    
    const col = document.createElement('div');
    col.className = 'col-md-6';
    
    col.innerHTML = `
      <div class="card wash-bay-card ${isAvailable ? 'available' : 'busy'}" 
           style="cursor: ${isAvailable ? 'pointer' : 'not-allowed'}; opacity: ${isAvailable ? 1 : 0.6}"
           onclick="${isAvailable ? `selectWashBay(${bay.id})` : ''}">
        <div class="card-body text-center">
          <h6>${bay.name}</h6>
          <small class="text-muted">${bay.description || ''}</small>
          <div class="mt-2">
            <span class="badge ${isAvailable ? 'bg-success' : 'bg-danger'}">
              ${isAvailable ? '–°–≤–æ–±–æ–¥–Ω–æ' : '–ó–∞–Ω—è—Ç–æ'}
            </span>
          </div>
        </div>
      </div>
    `;
    
    grid.appendChild(col);
    if (isAvailable) availableCount++;
  });
  
  if (availableCount === 0) {
    noSlots.style.display = 'block';
  } else {
    noSlots.style.display = 'none';
  }
}

function isWashBayAvailable(washBayId, dateTime) {
  const targetTime = new Date(dateTime);
  const targetEnd = new Date(targetTime.getTime() + 60 * 60 * 1000); // +1 —á–∞—Å
  
  const conflictingAppt = storage.appointments.find(appt => {
    if (appt.washBayId !== washBayId) return false;
    if (appt.status === 'cancelled' || appt.status === 'completed') return false;
    
    const apptStart = new Date(appt.dateTime);
    const apptEnd = new Date(apptStart.getTime() + 60 * 60 * 1000); // +1 —á–∞—Å
    
    return (targetTime < apptEnd && targetEnd > apptStart);
  });
  
  return !conflictingAppt;
}

function selectWashBay(washBayId) {
  $('#apptWashBay').value = washBayId;
  const bay = storage.washBays.find(b => b.id === washBayId);
  if (bay) {
    showToast(`–í—ã–±—Ä–∞–Ω–æ –º–µ—Å—Ç–æ: ${bay.name}`);
  }
  bootstrap.Modal.getInstance($('#washBaySelectionModal')).hide();
}

function applyFilters() {
  renderApptsTable();
}

function getFilteredAppointments() {
  const statusFilter = $('#filterStatus').value;
  const carWashFilter = $('#filterCarWash').value;
  const dateFrom = $('#filterDateFrom').value;
  const dateTo = $('#filterDateTo').value;
  
  return storage.appointments.filter(appt => {
    if (statusFilter && appt.status !== statusFilter) return false;
    
    if (carWashFilter && appt.washBayId) {
      const bay = storage.washBays.find(b => b.id === appt.washBayId);
      if (!bay || bay.carWashId != carWashFilter) return false;
    }
    
    if (dateFrom || dateTo) {
      const apptDate = new Date(appt.dateTime).toISOString().split('T')[0];
      if (dateFrom && apptDate < dateFrom) return false;
      if (dateTo && apptDate > dateTo) return false;
    }
    
    return true;
  });
}

function renderLoadDashboard() {
  const date = $('#loadDashboardDate').value || new Date().toISOString().split('T')[0];
  const container = $('#loadDashboardContent');
  container.innerHTML = '';
  
  storage.carWashes.forEach(carWash => {
    const washCard = document.createElement('div');
    washCard.className = 'card mb-4';
    washCard.innerHTML = `
      <div class="card-header">
        <h6 class="mb-0">${carWash.name}</h6>
        <small class="text-muted">${carWash.address}</small>
      </div>
      <div class="card-body">
        <div id="wash-${carWash.id}-schedule" class="schedule-container"></div>
      </div>
    `;
    container.appendChild(washCard);
    
    renderWashSchedule(carWash.id, date);
  });
}

function renderWashSchedule(carWashId, date) {
  const container = $(`#wash-${carWashId}-schedule`);
  const washBays = storage.washBays.filter(bay => bay.carWashId === carWashId);
  
  let html = '<div class="schedule-grid">';

  html += '<div class="schedule-header">';
  html += '<div class="time-slot"></div>';
  for (let hour = 8; hour < 22; hour++) {
    html += `<div class="time-slot">${hour}:00</div>`;
  }
  html += '</div>';

  washBays.forEach(bay => {
    html += `<div class="schedule-row">
      <div class="bay-name">${bay.name}</div>`;
    
    for (let hour = 8; hour < 22; hour++) {
      const slotStart = new Date(date + 'T' + hour.toString().padStart(2, '0') + ':00');
      const slotEnd = new Date(slotStart.getTime() + 60 * 60 * 1000);
      
      const appointment = findAppointmentForSlot(bay.id, slotStart, slotEnd);
      const statusClass = appointment ? getStatusClass(appointment.status) : 'free';
      const title = appointment ? 
        `${getClientName(appointment.clientId)} - ${getServiceName(appointment.serviceId)}` : 
        '–°–≤–æ–±–æ–¥–Ω–æ';
      
      html += `<div class="time-slot ${statusClass}" title="${title}">
        ${appointment ? '‚óè' : ''}
      </div>`;
    }
    
    html += '</div>';
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function findAppointmentForSlot(washBayId, slotStart, slotEnd) {
  return storage.appointments.find(appt => {
    if (appt.washBayId !== washBayId) return false;
    if (appt.status === 'cancelled') return false;
    
    const apptStart = new Date(appt.dateTime);
    const apptEnd = new Date(apptStart.getTime() + 60 * 60 * 1000);
    
    return (slotStart < apptEnd && slotEnd > apptStart);
  });
}

function getStatusClass(status) {
  const statusClasses = {
    'pending': 'status-pending',
    'confirmed': 'status-confirmed',
    'arrived': 'status-arrived',
    'in_wash': 'status-inwash',
    'completed': 'status-completed'
  };
  return statusClasses[status] || 'status-unknown';
}

function getClientName(clientId) {
  const client = storage.clients.find(c => c.id === clientId);
  return client ? client.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
}

function getServiceName(serviceId) {
  const service = storage.services.find(s => s.id === serviceId);
  return service ? service.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
}

function updateDashboard(){
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const weekAgo = new Date(today);
  weekAgo.setDate(today.getDate() - 7);
  const monthAgo = new Date(today);
  monthAgo.setMonth(today.getMonth() - 1);

  const completed = storage.appointments.filter(a => a.status === 'completed');

  const revenueToday = completed.filter(a => new Date(a.dateTime).toDateString() === today.toDateString()).reduce((sum, a) => sum + (a.price || 0), 0);
  const revenueWeek = completed.filter(a => new Date(a.dateTime) >= weekAgo).reduce((sum, a) => sum + (a.price || 0), 0);
  const revenueMonth = completed.filter(a => new Date(a.dateTime) >= monthAgo).reduce((sum, a) => sum + (a.price || 0), 0);
  
  const completedToday = completed.filter(a => new Date(a.dateTime).toDateString() === today.toDateString()).length;
  const activeWeek = storage.appointments.filter(a => new Date(a.dateTime) >= weekAgo && a.status !== 'cancelled').length;

  $('#revenue-today').textContent = `${revenueToday} ‚ÇΩ`;
  $('#revenue-week').textContent = `${revenueWeek} ‚ÇΩ`;
  $('#revenue-month').textContent = `${revenueMonth} ‚ÇΩ`;
  $('#completed-today').textContent = completedToday;
  $('#active-week').textContent = activeWeek;
  $('#total-appointments').textContent = storage.appointments.length;
  $('#total-clients').textContent = storage.clients.length;
  $('#total-cars').textContent = storage.cars.length;

  renderRecentAppointments();
}

function renderCharts(){
  const now = new Date();
  const labels = [];
  const data = [];
  for(let i=6;i>=0;i--){
    const d = new Date(now); d.setDate(now.getDate()-i);
    const iso = d.toISOString().split('T')[0];
    labels.push(d.toLocaleDateString('ru-RU',{day:'2-digit', month:'short'}));
    data.push(storage.appointments.filter(a=> a.dateTime.startsWith(iso)).length);
  }
  const ctx1 = document.getElementById('chartDaily').getContext('2d');
  if(chartDaily) chartDaily.destroy();
  const grad = ctx1.createLinearGradient(0,0,0,300); grad.addColorStop(0,'rgba(124,58,237,0.9)'); grad.addColorStop(1,'rgba(6,182,212,0.12)');
  chartDaily = new Chart(ctx1, {
    type:'line',
    data:{ labels, datasets:[{ label:'–ó–∞–ø–∏—Å–∏', data, borderColor:'#7c3aed', backgroundColor:grad, fill:true, tension:0.38, pointRadius:4 }]},
    options:{ responsive:true, plugins:{ legend:{display:false}, tooltip:{mode:'index'}}, scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 }}} }
  });
  const map = {};
  storage.appointments.forEach(a=>{
    const s = storage.services.find(x=>x.id===a.serviceId);
    if(s) map[s.name] = (map[s.name]||0)+1;
  });
  const topLabels = Object.keys(map);
  const topData = Object.values(map);
  const ctx2 = document.getElementById('chartTop').getContext('2d');
  if(chartTop) chartTop.destroy();
  chartTop = new Chart(ctx2, {
    type:'doughnut',
    data:{ labels: topLabels, datasets:[{ data: topData, backgroundColor: ['#7c3aed','#06b6d4','#f59e0b','#ef4444','#10b981'] }]},
    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
  });
}

function fillSelects(){
  const clientSelects = [$('#carClientIds'), $('#apptClient')];
  clientSelects.forEach(sel => {
    if(sel) {
      sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option><option value="new">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</option>';
      storage.clients.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        sel.appendChild(opt);
      });
    }
  });

  const serviceSelect = $('#apptService');
  if(serviceSelect) {
    serviceSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>';
    storage.services.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = `${s.name} (${s.price} ‚ÇΩ)`;
      opt.dataset.price = s.price;
      serviceSelect.appendChild(opt);
    });
  }

  const empSelects = [$('#apptEmployee'), $('#shiftEmployeeId')];
  empSelects.forEach(sel => {
    if(sel) {
      sel.innerHTML = '<option value="">‚Äî</option>';
      storage.employees.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.id;
        opt.textContent = e.name;
        sel.appendChild(opt);
      });
    }
  });

  const carWashSelect = $('#washBayCarWashId');
  if(carWashSelect) {
    carWashSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–π–∫—É</option>';
    storage.carWashes.forEach(cw => {
      const opt = document.createElement('option');
      opt.value = cw.id;
      opt.textContent = cw.name;
      carWashSelect.appendChild(opt);
    });
  }
  const washBaySelect = $('#apptWashBay');
  if(washBaySelect) {
    washBaySelect.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>';
    storage.washBays.forEach(bay => {
      const carWash = storage.carWashes.find(w => w.id === bay.carWashId);
      const opt = document.createElement('option');
      opt.value = bay.id;
      opt.textContent = `${bay.name} (${carWash?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'})`;
      washBaySelect.appendChild(opt);
    });
  }
}

function loadCarsForClient(){
  const clientId = parseInt($('#apptClient').value) || null;
  const carSelect = $('#apptCar'); 
  if(!carSelect) return;
  
  carSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ</option><option value="new">+ –ù–æ–≤–æ–µ –∞–≤—Ç–æ</option>';
  if(!clientId) return;
  
  const cars = storage.cars.filter(c => c.clientIds.includes(clientId));
  if(cars.length === 0) {
    const opt = document.createElement('option');
    opt.textContent = "–ù–µ—Ç –∞–≤—Ç–æ";
    opt.disabled = true;
    carSelect.appendChild(opt);
  } else {
    cars.forEach(car => {
      const opt = document.createElement('option');
      opt.value = car.id;
      opt.textContent = `${car.plate} ‚Äî ${car.brand} ${car.model}`;
      carSelect.appendChild(opt);
    });
  }
}

function updateAppointmentPrice(){
  const serviceId = $('#apptService').value;
  const service = storage.services.find(s => s.id == serviceId);
  $('#apptPrice').value = service ? service.price : '';
}

function fillFilterSelects() {
  const carWashSelect = $('#filterCarWash');
  carWashSelect.innerHTML = '<option value="">–í—Å–µ –º–æ–π–∫–∏</option>';
  storage.carWashes.forEach(wash => {
    const option = document.createElement('option');
    option.value = wash.id;
    option.textContent = wash.name;
    carWashSelect.appendChild(option);
  });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
$('#globalSearch').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  const suggWrap = $('#searchSuggestions'); suggWrap.innerHTML='';
  if(!q){ suggWrap.style.display='none'; return; }
  const results = [];
  storage.clients.forEach(c=> { if(c.name.toLowerCase().includes(q)|| (c.phone||'').includes(q)) results.push({type:'client', text:c.name}); });
  storage.cars.forEach(c=> { if((c.plate||'').toLowerCase().includes(q)) results.push({type:'car', text:c.plate+' ‚Äî '+c.brand+' '+c.model}); });
  storage.services.forEach(s=> { if(s.name.toLowerCase().includes(q)) results.push({type:'service', text:s.name}); });
  if(results.length===0){ suggWrap.style.display='none'; return; }
    suggWrap.style.display='block';
  const list = document.createElement('div'); list.className='card'; list.style.padding='8px';
  results.slice(0,6).forEach(r=>{
    const it = document.createElement('div'); it.className='py-1 px-2'; it.style.cursor='pointer';
    it.textContent = (r.type==='client'?'üë§ ':'') + r.text;
    it.addEventListener('click', ()=> { $('#globalSearch').value = r.text; suggWrap.innerHTML=''; suggWrap.style.display='none'; });
    list.appendChild(it);
  });
  suggWrap.appendChild(list);
});

$('#saveClientBtn').addEventListener('click', saveClient);
$('#saveCarBtn').addEventListener('click', saveCar);
$('#saveServiceBtn').addEventListener('click', saveService);
$('#saveEmployeeBtn').addEventListener('click', saveEmployee);
$('#saveApptBtn').addEventListener('click', saveAppt);
$('#saveShiftBtn').addEventListener('click', saveShift);
$('#saveCarWashBtn').addEventListener('click', saveCarWash);
$('#saveWashBayBtn').addEventListener('click', saveWashBay);

$('#apptClient').addEventListener('change', loadCarsForClient);
$('#apptService').addEventListener('change', updateAppointmentPrice);

$('#apptCar').addEventListener('change', function() {
  if (this.value === 'new') {
    $('#newCarFields').style.display = 'block';
  } else {
    $('#newCarFields').style.display = 'none';
  }
});

$('#apptClient').addEventListener('change', function() {
  if (this.value === 'new') {
    $('#apptCar').innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ</option><option value="new">+ –ù–æ–≤–æ–µ –∞–≤—Ç–æ</option>';
    $('#newCarFields').style.display = 'none';
  }
});

$('#apptDateTime').addEventListener('change', function() {
  setTimeout(() => {
    if (this.value && !$('#appointmentId').value) {
      openWashBayModal();
    }
  }, 1000);
});

$('#openCreate').addEventListener('click', ()=> { 
  resetAppointmentModal();
  new bootstrap.Modal($('#appointmentModal')).show(); 
});

$('#exportCsvBtn').addEventListener('click', ()=>{
  const headers = ['–î–∞—Ç–∞','–ö–ª–∏–µ–Ω—Ç','–ê–≤—Ç–æ','–£—Å–ª—É–≥–∞','–°–æ—Ç—Ä—É–¥–Ω–∏–∫','–°—Ç–∞—Ç—É—Å','–¶–µ–Ω–∞'];
  const rows = storage.appointments.map(a=>{
    const c = storage.clients.find(x=>x.id===a.clientId)||{};
    const car = storage.cars.find(x=>x.id===a.carId)||{};
    const srv = storage.services.find(x=>x.id===a.serviceId)||{};
    const emp = storage.employees.find(x=>x.id===a.employeeId)||{};
    return [new Date(a.dateTime).toLocaleString(), c.name||'', car.plate||'', srv.name||'', emp.name||'', a.status, a.price||0];
  });
  const csv = [headers, ...rows].map(r=> r.map(cell=>`"${String(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'appointments.csv'; a.click();
  URL.revokeObjectURL(url);
  showToast('–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤');
});

$('#clientModal').addEventListener('hidden.bs.modal', resetClientModal);
$('#carModal').addEventListener('hidden.bs.modal', resetCarModal);
$('#serviceModal').addEventListener('hidden.bs.modal', resetServiceModal);
$('#employeeModal').addEventListener('hidden.bs.modal', resetEmployeeModal);
$('#appointmentModal').addEventListener('hidden.bs.modal', resetAppointmentModal);
$('#shiftModal').addEventListener('hidden.bs.modal', resetShiftModal);
$('#carWashModal').addEventListener('hidden.bs.modal', resetCarWashModal);
$('#washBayModal').addEventListener('hidden.bs.modal', resetWashBayModal);

$('#appointmentModal').addEventListener('show.bs.modal', function() {
  if (!$('#appointmentId').value) {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    $('#apptDateTime').value = now.toISOString().slice(0, 16);
  }
});

$('#shiftModal').addEventListener('show.bs.modal', function() {
  if (!$('#shiftId').value) {
    $('#shiftDate').value = new Date().toISOString().split('T')[0];
  }
});

$('#notifBtn').addEventListener('click', function() {
  const pendingAppointments = storage.appointments.filter(a => a.status === 'pending');
  if (pendingAppointments.length > 0) {
    showToast(`–û–∂–∏–¥–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${pendingAppointments.length} –∑–∞–ø–∏—Å–µ–π`, 'success');
  } else {
    showToast('–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π', 'success');
  }
  $('#notifPing').style.display = 'none';
});

setInterval(() => {
  if ($('#dashboard').style.display !== 'none') {
    updateDashboard();
  }
}, 60000);

document.addEventListener('click', function(e) {
  if (!e.target.closest('#searchBox')) {
    $('#searchSuggestions').style.display = 'none';
  }
});

document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    $('#globalSearch').focus();
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
    e.preventDefault();
    resetAppointmentModal();
    new bootstrap.Modal($('#appointmentModal')).show();
  }
});

window.addEventListener('resize', function() {
  if (window.innerWidth < 900) {
    document.querySelector('.sidebar').style.width = '66px';
    document.querySelector('.sidebar').style.minWidth = '66px';
  }
});

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ window –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ HTML
window.editClient = editClient;
window.deleteClient = deleteClient;
window.editCar = editCar;
window.deleteCar = deleteCar;
window.editService = editService;
window.deleteService = deleteService;
window.editEmployee = editEmployee;
window.deleteEmployee = deleteEmployee;
window.editAppt = editAppt;
window.deleteAppt = deleteAppt;
window.editShift = editShift;
window.deleteShift = deleteShift;
window.editCarWash = editCarWash;
window.deleteCarWash = deleteCarWash;
window.editWashBay = editWashBay;
window.deleteWashBay = deleteWashBay;
window.loadCarsForClient = loadCarsForClient;
window.updateAppointmentPrice = updateAppointmentPrice;
window.openWashBayModal = openWashBayModal;
window.selectWashBay = selectWashBay;
window.applyFilters = applyFilters;
window.quickChangeStatus = quickChangeStatus;
window.saveQuickStatus = saveQuickStatus;
</script>
</body>
</html>